<?php

require_once("controller/frontend.php");

try	{	// instruction permettant de récupérer les erreurs éventuelles dans l'instruction 'catch' 

	// Initialisation de la session et des variables
	session_start();	// active la session sur le serveur (accès aux variables de session)
	
	// Vérification de l'état de login du visiteur en vérifiante la valeur de la
	// variable de session 'nom'. 

	// Si la variable de session "nom" existe, c'est que le visiteur est connecté
	// avec un mot de passe valide. Dans ce cas, on peuple la variable $logout 
	// avec le code html ci dessus qui sera rendu dans le header de la page 
	// visitée et crée un lien pour pouvoir se déconnecter.
	// Le lien appelle une fonction javascript "logout()", inclue dans la page 
	// html et qui permet de se déconnecter en ajax, sans devoir recharger la 
	// page.  Voir dans le fichier scripts/JS/assistants.js pour cette fonction.
	//
	// Si la session n'est pas ouverte, la variable $logout est vide et donc rien n'est affiché.

	$nom = (isset($_SESSION['nom'])) ? htmlspecialchars($_SESSION['nom']) : '';
	$page = (isset($_GET['page'])) ? htmlspecialchars($_GET['page']) : 'homepage'; //page à générer
	$action = (isset($_GET['action'])) ? htmlspecialchars($_GET['action']) : ''; // Action à faire
	$parameter1 = (isset($_GET['param1'])) ? htmlspecialchars($_GET['param1']) : ''; // Paramètre 1

	
	// TODO - harmoniser les noms de pages et des fonctions et remplacer le dico par la liste 
	$pagesArray = array(
		'graphique' => 'graphique',
		'table' => 'tableData',
		'photolist' => 'photolist',
		'photothumb' => 'photothumb',
		'information' => 'information',
		'reglages' => 'reglage', //tomodify with test is already connected
		'login' => 'login', //tomodify with test is already connected
		'logout'=> 'logout',
		'loginVerify' => 'loginVerify',
		'doreglages' => 'doReglages',
		'homepage' => 'homePage'
	);

	if ( ! array_key_exists($page, $pagesArray)) { 
		throw new Exception('Page non valide !');
	}
	else {
		$_SESSION['pageCourante'] = $page;
		$pagesArray[$page]($nom, $action, $parameter1);
	}
		
	
//	if (isset($_SESSION['nom'])) {
//		$logout="<br><span id='logout' onclick=''>bonjour, ".$nom." !<br><a href='index.php?page=logout'> Se déconnecter </a></span>";
//	}
//	else {
//		$logout="<br><span id='logout' onclick=''><br>Bienvenu cher visiteur,<br><a href='index.php?page=login'>Se connecter</a></span>";
//	}
	
	// Récupération des variables transmises par la variable superglobale $_GET
	// La fonction 'htmlspecialchars' est nécessaire pour la sécurité : elle neutralise les tentatives d'injection de code HTML par un utilisateur malveillant
	
	// ----------------------------------------------------------------------------------

// Redirection en fonction de la page et de l'action demandée
	if ($page == 'graphique') {			// ------------------ Graphique
		$_SESSION['pageCourante'] = $page;
       	graphique($nom);
   	}
	elseif ($page == 'table') {			// ------------------ Table
		$_SESSION['pageCourante'] = $page;
		tableData($nom);
	}
	elseif ($page == 'photolist') {		// ------------------ Photolist
		$_SESSION['pageCourante'] = $page;
		photolist($nom, $parameter1);
	}
	elseif ($page == 'photothumb') {	// ------------------ PhotoThumbnail
		$_SESSION['pageCourante'] = $page;
		photothumb($nom, $action);
	}
	elseif ($page == 'information') {	// ------------------ Information
		$_SESSION['pageCourante'] = $page;
       	information($nom);
   	}
	elseif ($page == 'reglages') {		// ------------------ Reglages
		$_SESSION['pageCourante'] = $page;
//		if ($nom != '') {
		if ($nom == '') {
			reglage($nom);
		}
		else {
			$message = "L'accès aux réglages du nichoir nécessite un nom d'utilisateur et un mot de passe.<br/><br/> Merci de compléter ce formulaire :";
			login($message);
		}
	}
	elseif ($page == 'login') {			// ------------------ Login
		if(isset($_SESSION['message'])){
			$message = $_SESSION['message'];
		}
		else {
			$message = "L'accès aux réglages du nichoir nécessite un nom d'utilisateur et un mot de passe.<br/><br/> Merci de compléter ce formulaire :";
		}
		login($message);
	}
	elseif ($page == 'logout') {		// ------------------ Logout
		logOut();
	}	
	elseif ($page == 'loginVerify') {	// ------------------ Login Verify
		loginVerify($_POST['login'],$_POST['passe']);
	}

	elseif ($page == 'doreglages') {	// ------------------ Do Reglages
		doReglages();
	}
	
	elseif ($page == 'homepage' or $page == '') {		// ------------------ Homepage
		$_SESSION['pageCourante'] = 'homePage';
		homePage($nom);
	}

	else{								// ------------------ Erreur - Page non valide
		throw new Exception('Page non valide !');
	}
}


catch(Exception $e) {
   	// S'il y a eu une erreur, alors...
    echo 'Erreur : ' . $e->getMessage();
}


